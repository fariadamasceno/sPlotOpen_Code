# Documentation on the code to resample sPlot

This is the open-source R code (CC-BY Jonathan Lenoir & Tarek Hattab) that implements the resampling of the original sPlot database v2.1 into environmentally-balanced subsets.

There is three main files with the code to: 

**1.** Run a global principal component analysis (PCA) encapsulating the entire environmental space covered by terrestrial systems ["*01_running_a_global_PCA_on_bioclimatic_and_soil_variables.R*"]

**2.** Resample the sPlot vegetation database in a systematic manner across the 2D-space covered by the first two principal components (PCs) of the PCA from step 1 [*02_resampling_sPlot_within_the_PC1-PC2_environmental_space.R*]

**3.** Extract the set of selected vegetation plots from the sPlot database using the outputs produced by the resampling algorithm in step 2 [*03_extracting_selected_plots_from_the_sPlot_database.R*]

# 1. The global PCA

The R script file "*01_running_a_global_PCA_on_bioclimatic_and_soil_variables.R*" contains the code to run the PCA. It first loads a large dataset of 30 variables reflecting bioclimatic and soil conditions. All these variables can be downloaded from the original open-access archives storing the global raster grids (CHELSA, CGIAR-CSI & SoilGrids). After running the global PCA and interpreting the meaning of the first two to three PCs, the script allows to: (1) extract data from the first three PCs (PC1, PC2 & PC3); (2) store these data into global raster grids, one for each PC; and (3) to map the outputs at the global extent.

# 2. The resampling algorithm

The R script file "*02_resampling_sPlot_within_the_PC1-PC2_environmental_space.R*" contains the code that: (1) loads the original sPlot database v2.1 (both the header data and the species composition data stored into two different dataframes); (2) cleans sPlot v2.1 to extract the set of vegetation plots to be used for the resampling procedure; (3) runs a sensitivity analysis to define the most appropriate grid resolution to define the bivariate (PC1-PC2) environmental space to be used to perform the resampling; and (4) resamples sPlot within the PC1-PC2 environmental space using the heterogeneity‚Äêconstrained random (HCR) reseamping algorithm (several times to get several possible iterations: 100).

The HCR resampling algorithm was initially written by Attila Lengyel. We adapted the original algorithm and code to our own need for the resampling of sPlot. Due to the large amount of data in sPlot, the large dissimilarity matrices generated by the HCR algorithm (pairwise distance matrices based on plant community composition) and to speed up the processing time to resample sPlot, Tarek Hattab wrote several useful functions in C++ (see the folder entitled "*_functions_TH*" that contains all the functions written by Tarek and that are then sourced from R using the sourceCpp function from the Rcpp package). Note that you need to install Rtools on Windows machines to be able to run this set of functions. Also, we do not take any responsibility if our code makes your computer explode...

# 3. The result

The actual output of the resampling algorithm does not list the set of vegetation plot IDs selected by the resampling apporach for each of the 100 HCR runs but rather the list of vegetation plot IDs not selected by the resampling approach, i.e., the garbage. This is the reason why the main output of the resampling algorithm is stored in a list object called "plotToRemove". The last R script file "*03_extracting_selected_plots_from_the_sPlot_database.R*" thus contains the code to remove (for each of the 100 HCR runs) the set of non-selected plots from the sPlot 2.1 database so that we get in the end several possible realisations of environmentally-balanced datasets representative of sPlot.
